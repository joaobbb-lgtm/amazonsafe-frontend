<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>AmazonSafe ‚Äì Mapa e Alertas</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#16a34a',
            amberish: '#f59e0b',
            slateish: '#0f172a',
          }
        }
      }
    }
  </script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

  <style>
    #map { height: 64vh; min-height: 380px; }
    .pill { display:inline-flex; align-items:center; padding:0.125rem 0.625rem; border-radius:9999px; font-size:0.75rem; font-weight:600; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- HEADER -->
  <header class="sticky top-0 z-20 bg-white border-b border-gray-200">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4 flex-wrap">
    <div class="flex items-center gap-4 min-w-[280px]">
      <!-- Logo -->
      <img src="assets/logo.png" alt="AmazonSafe" class="h-[80px] w-[80px] rounded-full object-cover" />

      <!-- Bloco de t√≠tulo + subt√≠tulo com largura do t√≠tulo -->
      <div class="inline-block" id="brandBlock">
        <!-- T√≠tulo: define a largura do bloco -->
        <div class="text-4xl font-extrabold leading-tight whitespace-nowrap">
          Amazon<span class="text-emerald-600">Safe</span>
        </div>

        <!-- Subt√≠tulo: mesma largura do bloco acima, um pouco menor -->
        <div class="text-[14px] text-gray-600 -mt-1 whitespace-nowrap">
          Monitoramento Ambiental Inteligente
        </div>
      </div>

      <!-- Badge da API ao lado (n√£o embaixo) -->
      <span class="ml-3 text-xs bg-indigo-50 text-indigo-700 px-2.5 py-1 rounded-full">
        API: amazonsafe-api.onrender.com
      </span>
    </div>

    <div class="ml-auto flex gap-2 flex-wrap">
      <input id="cidade" placeholder="Cidade (ex: Bel√©m, PA)" class="p-2 border border-gray-300 rounded-lg min-w-[210px] text-gray-800" />
      <input id="lat" type="number" step="0.0001" placeholder="Lat" class="p-2 border border-gray-300 rounded-lg w-28 text-gray-800" />
      <input id="lon" type="number" step="0.0001" placeholder="Lon" class="p-2 border border-gray-300 rounded-lg w-28 text-gray-800" />
      <button id="btnGo" class="p-2 px-4 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-lg transition duration-150 disabled:opacity-60 disabled:cursor-not-allowed">
        Buscar & Analisar
      </button>
    </div>
  </div>
</header>


  <!-- KPIs -->
  <main class="max-w-7xl mx-auto px-3 lg:px-4">
    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mt-4">
      <!-- √Ågua -->
      <div id="kpiAgua" class="bg-white rounded-xl border border-gray-200 shadow-sm">
        <div id="kpiAguaTop" class="border-b-4 border-emerald-500 rounded-t-xl"></div>
        <div class="p-4">
          <p class="text-xs uppercase text-gray-500 font-semibold">√Ågua (chuva/cheia)</p>
          <p id="aguaTitulo" class="text-3xl font-bold text-emerald-800 mt-1">‚Äî</p>
          <p id="aguaInfo" class="text-sm text-gray-600 mt-1">‚Äî</p>
          <span id="aguaBadge" class="pill bg-emerald-100 text-emerald-700 mt-2">‚Äî</span>
        </div>
      </div>

      <!-- Ar -->
      <div id="kpiAr" class="bg-white rounded-xl border border-gray-200 shadow-sm">
        <div id="kpiArTop" class="border-b-4 border-sky-500 rounded-t-xl"></div>
        <div class="p-4">
          <p class="text-xs uppercase text-gray-500 font-semibold">Qualidade do Ar</p>
          <p id="arTitulo" class="text-3xl font-bold text-sky-800 mt-1">‚Äî</p>
          <p id="arInfo" class="text-sm text-gray-600 mt-1">‚Äî</p>
          <span id="arBadge" class="pill bg-sky-100 text-sky-700 mt-2">‚Äî</span>
        </div>
      </div>

      <!-- Desmatamento (proxy) -->
      <div id="kpiDesm" class="bg-white rounded-xl border border-gray-200 shadow-sm">
        <div id="kpiDesmTop" class="border-b-4 border-emerald-700 rounded-t-xl"></div>
        <div class="p-4">
          <p class="text-xs uppercase text-gray-500 font-semibold">Desmatamento (proxy)</p>
          <p id="desmTitulo" class="text-3xl font-bold text-emerald-900 mt-1">‚Äî</p>
          <p id="desmInfo" class="text-sm text-gray-600 mt-1">‚Äî</p>
          <span id="desmBadge" class="pill bg-emerald-100 text-emerald-700 mt-2">‚Äî</span>
        </div>
      </div>

      <!-- Focos -->
      <div id="kpiFocos" class="bg-white rounded-xl border border-gray-200 shadow-sm">
        <div id="kpiFocosTop" class="border-b-4 border-red-600 rounded-t-xl"></div>
        <div class="p-4">
          <p class="text-xs uppercase text-gray-500 font-semibold">Focos de Inc√™ndio</p>
          <p id="focosTitulo" class="text-3xl font-bold text-red-700 mt-1">‚Äî</p>
          <p id="focosInfo" class="text-sm text-gray-600 mt-1">‚Äî</p>
          <span id="focosBadge" class="pill bg-red-100 text-red-700 mt-2">‚Äî</span>
        </div>
      </div>
    </section>

    <!-- MAPA + LADO DIREITO -->
    <section class="grid lg:grid-cols-3 gap-4 mt-4">
      <div class="lg:col-span-2 bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div id="map"></div>
      </div>

      <aside class="flex flex-col gap-4">
        <!-- Hist√≥rico de risco -->
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
          <h3 class="font-semibold text-emerald-800 mb-2">Hist√≥rico de Risco</h3>
          <div class="h-40">
            <canvas id="riscoHistorico"></canvas>
          </div>
        </div>

        <!-- Resultado da an√°lise -->
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
          <div class="flex items-center gap-3 flex-wrap">
            <strong class="text-lg font-semibold text-emerald-800">Resultado da an√°lise</strong>
            <span id="nivelPill" class="pill bg-gray-100 text-gray-700">‚Äî</span>
          </div>
          <div id="metaBox" class="text-gray-500 text-xs mt-2">
            Local: <strong>‚Äî</strong> ‚Ä¢ √öltima observa√ß√£o: <strong>‚Äî</strong>
          </div>

          <!-- Dentro do card Resultado da an√°lise -->
          <div class="grid grid-cols-2 gap-3 mt-2">
            <div class="p-3 border rounded-lg">
              <div class="text-xs text-gray-500">Score (0‚Äì1)</div>
              <div class="text-xl font-bold"><span id="scoreValue">‚Äî</span></div>
            </div>
            <div class="p-3 border rounded-lg">
              <div class="text-xs text-gray-500">Thresholds</div>
              <div class="text-sm text-gray-700">
                <span id="threshText">verde &lt; 0.33 ‚Ä¢ amarelo 0.33‚Äì0.66 ‚Ä¢ vermelho ‚â• 0.66</span>
              </div>
            </div>
          
            <div class="p-3 border rounded-lg">
              <div class="text-xs text-gray-500">Severity</div>
              <div class="text-lg font-semibold"><span id="sevValue">‚Äî</span></div>
            </div>
            <div class="p-3 border rounded-lg">
              <div class="text-xs text-gray-500">Duration</div>
              <div class="text-lg font-semibold"><span id="durValue">‚Äî</span></div>
            </div>
          
            <div class="p-3 border rounded-lg">
              <div class="text-xs text-gray-500">Frequency</div>
              <div class="text-lg font-semibold"><span id="freqValue">‚Äî</span></div>
            </div>
            <div class="p-3 border rounded-lg">
              <div class="text-xs text-gray-500">Impact</div>
              <div class="text-lg font-semibold"><span id="impValue">‚Äî</span></div>
            </div>
          </div>


          <pre id="resumoBox" class="whitespace-pre-wrap text-sm mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-700"></pre>
        </div>

        <!-- √öltimos alertas -->
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
          <div class="flex justify-between items-center gap-2">
            <strong class="text-lg font-semibold text-emerald-800">√öltimos alertas</strong>
            <span class="text-xs text-gray-500">‚Ä¢ c√≠rculo menor = foco fraco</span>
          </div>
          <pre id="alertasBox" class="whitespace-pre-wrap text-xs mt-3 bg-gray-50 border border-gray-200 rounded-lg p-2"></pre>
        </div>
      </aside>
    </section>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ====== CONFIG ===========================================================
    const API = "https://amazonsafe-api.onrender.com";

    // ====== DOM ==============================================================
    const elCidade = document.querySelector('#cidade');
    const elLat    = document.querySelector('#lat');
    const elLon    = document.querySelector('#lon');
    const btnGo    = document.querySelector('#btnGo');

    // KPIs
    const aguaTitulo = document.querySelector('#aguaTitulo');
    const aguaInfo   = document.querySelector('#aguaInfo');
    const aguaBadge  = document.querySelector('#aguaBadge');
    const kpiAguaTop = document.querySelector('#kpiAguaTop');

    const arTitulo = document.querySelector('#arTitulo');
    const arInfo   = document.querySelector('#arInfo');
    const arBadge  = document.querySelector('#arBadge');
    const kpiArTop = document.querySelector('#kpiArTop');

    const desmTitulo = document.querySelector('#desmTitulo');
    const desmInfo   = document.querySelector('#desmInfo');
    const desmBadge  = document.querySelector('#desmBadge');
    const kpiDesmTop = document.querySelector('#kpiDesmTop');

    const focosTitulo = document.querySelector('#focosTitulo');
    const focosInfo   = document.querySelector('#focosInfo');
    const focosBadge  = document.querySelector('#focosBadge');
    const kpiFocosTop = document.querySelector('#kpiFocosTop');

    // Resultado
    const nivelPill = document.querySelector('#nivelPill');
    const metaBox   = document.querySelector('#metaBox');
    const scoreVal  = document.querySelector('#scoreVal');
    const sevVal    = document.querySelector('#sevVal');
    const durVal    = document.querySelector('#durVal');
    const freqVal   = document.querySelector('#freqVal');
    const impVal    = document.querySelector('#impVal');
    const resumoBox = document.querySelector('#resumoBox');

    const alertasBox = document.querySelector('#alertasBox');

    // ====== MAPA =============================================================
    const map = L.map('map').setView([-3.1, -60.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    let focosLayer = L.layerGroup().addTo(map);

    // ====== GR√ÅFICO ==========================================================
    const riscoCtx = document.getElementById('riscoHistorico').getContext('2d');
    const riscoChart = new Chart(riscoCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{ label: 'Score', data: [], borderColor: 'rgb(16, 185, 129)', tension: 0.3, pointRadius: 4 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { min: 0, max: 1 } },
        plugins: { legend: { display: false } }
      }
    });

    // ====== HELPERS ==========================================================
    const get = (obj, path, def = undefined) => {
      try { return path.split('.').reduce((o,k)=> (o && k in o) ? o[k] : undefined, obj) ?? def; }
      catch { return def; }
    };
    const num = (v, def=null) => {
      const n = (typeof v === 'string' && v.trim() === '') ? NaN : Number(v);
      return Number.isFinite(n) ? n : def;
    };
    const clamp01 = (x) => Math.max(0, Math.min(1, x));
    const setPill = (el, text, classes) => { el.textContent = text; el.className = `pill ${classes}`; };

    function setNivelPill(level, hexColor) {
      // Prioriza a cor enviada pelo backend (score.level_color)
      const lv = (level || '').toLowerCase();
      if (hexColor && /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(hexColor)) {
        nivelPill.style.backgroundColor = hexColor;
        nivelPill.style.color = '#1f2937'; // cinza-800 para contraste m√©dio
      } else {
        nivelPill.style.backgroundColor = '';
        nivelPill.style.color = '';
      }
      let t = '‚Äî';
      if (lv.startsWith('verme')) t = 'üî¥ VERMELHO';
      else if (lv.startsWith('ama')) t = 'üü° AMARELO';
      else if (lv.startsWith('ver')) t = 'üü¢ VERDE';
      nivelPill.textContent = t;
      if (!hexColor) {
        // classes de fallback se n√£o vier cor
        nivelPill.className = 'pill ' + (
          lv.startsWith('verme') ? 'bg-red-100 text-red-700' :
          lv.startsWith('ama')   ? 'bg-amber-100 text-amber-800' :
          lv.startsWith('ver')   ? 'bg-emerald-100 text-emerald-700' :
                                   'bg-gray-100 text-gray-700'
        );
      } else {
        // mant√©m pill + remove tailwind predefinido
        nivelPill.className = 'pill';
      }
    }

    // chuva 24h e √≠ndice de cheia vindos do backend (score.breakdown)
    function getPrecipMM(resp) {
      const fromBreak = num(get(resp, 'score.breakdown.precip_24h_mm'), null);
      if (fromBreak !== null) return fromBreak;

      const pm = num(get(resp, 'weather.features.precipitation'), null)
              ?? num(get(resp, 'weather.current.precipitation'), null);
      return pm;
    }
    function getRainIndex(resp) {
      const idx = num(get(resp, 'score.breakdown.precip_index'), null);
      if (idx !== null) return clamp01(idx);
      const mm = getPrecipMM(resp);
      if (!Number.isFinite(mm)) return null;
      const low  = Math.min(1, mm / 10);
      const high = Math.min(1, Math.max(0, (mm - 70) / 50));
      return clamp01(Math.max(low, high));
    }
    function rainLevel(rainIdx) {
      if (!Number.isFinite(rainIdx)) return ['Sem dados', 'bg-gray-100 text-gray-700', '‚Äî', 'border-gray-200'];
      if (rainIdx < 0.33) return ['Baixo', 'bg-emerald-100 text-emerald-700', 'OK', 'border-emerald-500'];
      if (rainIdx < 0.66) return ['Moderado', 'bg-amber-100 text-amber-800', 'Aten√ß√£o', 'border-amber-500'];
      return ['Alto', 'bg-red-100 text-red-700', 'Risco de cheia', 'border-red-600'];
    }

    // ====== FETCH WRAPPER ====================================================
    async function fetchJson(url, opts) {
      const r = await fetch(url, opts);
      if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
      return r.json();
    }

    // ====== FOCOS & KPI DESMATAMENTO ========================================
    async function carregarFocos(params) {
      focosLayer.clearLayers();
      const qs = new URLSearchParams({ scope: "diario", region: "Brasil", limit: 300, ...params }).toString();
      const data = await fetchJson(`${API}/api/inpe/focos?${qs}`);
      const focos = (data.features && data.features.focos) || [];

      const frps = [];
      focos.forEach(f => {
        if (Number.isFinite(+f.frp)) frps.push(+f.frp);
        const m = L.circleMarker([f.latitude, f.longitude], {
          radius: Math.max(3, Math.min(12, (f.frp || 1) / 8)),
          color: '#b91c1c', weight: 1, fillOpacity: 0.75
        }).bindPopup(`
          <div><strong>${f.municipio || ''} - ${f.uf || ''}</strong></div>
          <div>Sat√©lite: ${f.satelite || '-'}</div>
          <div>FRP: ${f.frp ?? '-'}</div>
          <div>Bioma: ${f.bioma || '-'}</div>
        `);
        m.addTo(focosLayer);
      });

      if (focos.length) {
        const bounds = L.latLngBounds(focos.map(f => [f.latitude, f.longitude]));
        map.fitBounds(bounds.pad(0.2));
      }

      // KPI Focos
      const levelTxt = focos.length ? (focos.length >= 150 ? 'Cr√≠tico' : focos.length >= 50 ? 'Alerta' : 'Baixo') : 'Baixo';
      focosTitulo.textContent = levelTxt;
      focosInfo.textContent   = `Focos: ${focos.length}`;
      const focosClass = (focos.length >= 150) ? 'bg-red-100 text-red-700' : (focos.length >= 50) ? 'bg-amber-100 text-amber-800' : 'bg-emerald-100 text-emerald-700';
      setPill(focosBadge, levelTxt, focosClass);

      // Borda do card acompanha o n√≠vel
      kpiFocosTop.className = 'border-b-4 rounded-t-xl ' + ((focos.length >= 150) ? 'border-red-600' : (focos.length >= 50) ? 'border-amber-500' : 'border-emerald-500');

      // KPI Desmatamento (proxy por FRP m√©dio)
      const avgFRP = frps.length ? (frps.reduce((a,b)=>a+b,0)/frps.length) : 0;
      let desmLevel = 'Baixo', desmClass = 'bg-emerald-100 text-emerald-700', desmTop = 'border-emerald-700';
      if (avgFRP >= 7) { desmLevel = 'Alto'; desmClass = 'bg-red-100 text-red-700'; desmTop = 'border-red-600'; }
      else if (avgFRP >= 3) { desmLevel = 'Moderado'; desmClass = 'bg-amber-100 text-amber-800'; desmTop = 'border-amber-500'; }
      desmTitulo.textContent = desmLevel;
      desmInfo.textContent   = `FRP m√©dio: ${avgFRP ? avgFRP.toFixed(1) : '‚Äî'}`;
      setPill(desmBadge, desmLevel, desmClass);
      kpiDesmTop.className = 'border-b-4 rounded-t-xl ' + desmTop;

      return { count: focos.length, avgFRP };
    }

    // ====== √öLTIMOS ALERTAS ==================================================
    async function carregarUltimosAlertas() {
      try {
        const data = await fetchJson(`${API}/api/alertas?limit=5`);
        alertasBox.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        alertasBox.textContent = `Erro ao carregar alertas: ${e.message}`;
      }
    }

    // ====== EXECU√á√ÉO PRINCIPAL ==============================================
    function getParamsFromUI() {
      const cidade = elCidade.value.trim();
      const lat = num(elLat.value, null);
      const lon = num(elLon.value, null);
      if (cidade) return { cidade };
      if (lat === null || lon === null) throw new Error("Informe a cidade **ou** latitude/longitude v√°lidos.");
      return { lat, lon };
    }
    function extractCoords(resp, fallback) {
      if (get(resp, 'params.lat') && get(resp, 'params.lon')) return { lat: resp.params.lat, lon: resp.params.lon };
      if (get(resp, 'lat') && get(resp, 'lon')) return { lat: resp.lat, lon: resp.lon };
      if (get(resp, 'params.resolve.lat') && get(resp, 'params.resolve.lon')) return { lat: resp.params.resolve.lat, lon: resp.params.resolve.lon };
      return fallback;
    }
    function setLoading(on) { btnGo.disabled = on; }

    async function executar() {
      setLoading(true);
      resumoBox.className = 'whitespace-pre-wrap text-sm mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-700';
      try {
        const uiParams = getParamsFromUI();
        resumoBox.textContent = "Processando an√°lise...";

        // 1) Pipeline principal
        const data = await fetchJson(`${API}/api/alertas_update`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ...uiParams,
            scope: "diario",
            region: "Brasil",
            raio_km: 150,
            air_radius_m: 10000,
            weather_provider: "open-meteo"
          })
        });

        // 2) KPI √ÅGUA
        const mm  = getPrecipMM(data);
        const rix = getRainIndex(data);
        const [lvlTxt, lvlClass, badgeTxt, topClass] = rainLevel(rix);
        aguaTitulo.textContent = lvlTxt;
        aguaInfo.textContent   = Number.isFinite(mm) ? `Chuva 24h: ${mm.toFixed(1)} mm` : 'Sem dados';
        setPill(aguaBadge, badgeTxt, lvlClass);
        kpiAguaTop.className = 'border-b-4 rounded-t-xl ' + topClass;

        // 3) KPI AR (PM2.5) ‚Äî usa 'air_status' do backend quando n√£o houver esta√ß√£o pr√≥xima
        const airStatus = get(data, 'score.air_status') || get(data, 'air_status');
        const pm25 = num(get(data, 'air.features.pm25'), null) ?? num(get(data, 'air.pm25'), null);
        if (airStatus === 'sem_estacao') {
          arTitulo.textContent = '‚Äî';
          arInfo.textContent   = 'Sem esta√ß√£o pr√≥xima';
          setPill(arBadge, '‚Äî', 'bg-gray-100 text-gray-700');
          kpiArTop.className = 'border-b-4 rounded-t-xl border-gray-300';
        } else if (Number.isFinite(pm25)) {
          arTitulo.textContent = (pm25 < 12) ? 'Bom' : (pm25 < 35) ? 'Moderado' : 'Ruim';
          arInfo.textContent   = `PM2.5: ${pm25.toFixed(1)} ¬µg/m¬≥`;
          const c = (pm25 < 12) ? 'bg-emerald-100 text-emerald-700' : (pm25 < 35) ? 'bg-amber-100 text-amber-800' : 'bg-red-100 text-red-700';
          setPill(arBadge, arTitulo.textContent, c);
          kpiArTop.className = 'border-b-4 rounded-t-xl ' + ((pm25 < 12) ? 'border-emerald-500' : (pm25 < 35) ? 'border-amber-500' : 'border-red-600');
        } else {
          arTitulo.textContent = '‚Äî';
          arInfo.textContent   = 'Sem dados';
          setPill(arBadge, '‚Äî', 'bg-gray-100 text-gray-700');
          kpiArTop.className = 'border-b-4 rounded-t-xl border-gray-300';
        }

        // 4) Resultado da an√°lise (usa cor que vem do backend)
        const level   = get(data, 'score.level', 'N/A');
        const lvColor = get(data, 'score.level_color') || get(data, 'color'); // compat
        setNivelPill(level, lvColor);

        const resolved = get(data, 'params.resolve.display_name') || get(data, 'params.cidade') || elCidade.value.trim() || '‚Äî';
        const when = get(data, 'score.alert_obs.meta.observed_at') || get(data, 'observed_at') || '‚Äî';
        metaBox.innerHTML = `Local: <strong>${resolved}</strong> ‚Ä¢ √öltima observa√ß√£o: <strong>${when}</strong>`;

        const s  = num(get(data, 'score.score'), null);
        const br = get(data, 'score.breakdown', {});
        scoreVal.textContent = (s !== null) ? s.toFixed(2) : '‚Äî';
        sevVal.textContent   = Number.isFinite(+br.severity)  ? (+br.severity).toFixed(2)  : '‚Äî';
        durVal.textContent   = Number.isFinite(+br.duration)  ? (+br.duration).toFixed(2)  : '‚Äî';
        freqVal.textContent  = Number.isFinite(+br.frequency) ? (+br.frequency).toFixed(2) : '‚Äî';
        impVal.textContent   = Number.isFinite(+br.impact)    ? (+br.impact).toFixed(2)    : '‚Äî';

        // 5) Focos + Desmatamento proxy
        const coords = extractCoords(data, uiParams);
        const resFocos = await carregarFocos(coords);

        resumoBox.classList.add('text-emerald-700', 'font-semibold');
        resumoBox.textContent =
          `Focos plotados: ${resFocos.count}\nFonte: INPE (CSV)\nParams: ${JSON.stringify(coords, null, 2)}`;

        // 6) Hist√≥rico (anexa ponto)
        const ts = new Date().toLocaleDateString('pt-BR', { month:'2-digit', day:'2-digit' });
        if (s !== null) {
          riscoChart.data.labels.push(ts);
          riscoChart.data.datasets[0].data.push(s);
          if (riscoChart.data.labels.length > 20) {
            riscoChart.data.labels.shift();
            riscoChart.data.datasets[0].data.shift();
          }
          riscoChart.update();
        }

        // 7) √öltimos alertas
        await carregarUltimosAlertas();

      } catch (err) {
        resumoBox.classList.add('text-red-700', 'font-semibold');
        resumoBox.textContent = `Erro: ${err.message}`;
        console.error(err);
      } finally {
        setLoading(false);
      }
    }

    // ====== EVENTS / INIT ====================================================
    btnGo.addEventListener('click', executar);
    elCidade.addEventListener('keydown', (e) => { if (e.key === 'Enter') executar(); });
    carregarUltimosAlertas();
  </script>
  <script>
    // Mostra n√∫mero com fallback visual
    function safeNum(n, digits = 2) {
      return (typeof n === "number" && isFinite(n)) ? n.toFixed(digits) : "‚Äî";
    }
  
    // Resolve trilhas poss√≠veis no JSON (API pode mudar ligeiramente a forma)
    function pickScoreBundle(api) {
      // exemplos j√° vistos nos seus logs:
      // { score: {..., breakdown:{...}, alert_obs:{...}} }
      // { result:{ score:{...} } }
      // { persisted:{ ... }, score:{...} }
      const scoreObj =
        api?.score ??
        api?.result?.score ??
        api?.persisted?.score ?? null;
  
      // breakdown pode vir dentro de score.breakdown
      // ou como alert_obs no root (quando voc√™ persistiu os obs)
      const breakdown =
        scoreObj?.breakdown ??
        api?.alert_obs ??
        api?.score?.alert_obs ?? null;
  
      return { scoreObj, breakdown };
    }
  
    // Preenche o painel "Resultado da an√°lise"
    function renderAnalysis(api) {
      // log de inspe√ß√£o ‚Äì ajuda a debugar se vier vazio
      console.debug("API (chaves):", Object.keys(api || {}));
      console.debug("API exemplo:", api);
  
      const { scoreObj, breakdown } = pickScoreBundle(api);
  
      const $score = document.getElementById("scoreValue");
      const $sev   = document.getElementById("sevValue");
      const $dur   = document.getElementById("durValue");
      const $freq  = document.getElementById("freqValue");
      const $imp   = document.getElementById("impValue");
  
      if (!$score || !$sev || !$dur || !$freq || !$imp) {
        console.warn("IDs do painel de an√°lise n√£o encontrados no DOM.");
        return;
      }
  
      // Se n√£o veio score nenhum, mantenha tra√ßos e mostre aviso no console
      if (!scoreObj && !breakdown) {
        console.warn("Sem score/breakdown na resposta da API.");
        $score.textContent = "‚Äî";
        $sev.textContent   = "‚Äî";
        $dur.textContent   = "‚Äî";
        $freq.textContent  = "‚Äî";
        $imp.textContent   = "‚Äî";
        return;
      }
  
      // Score num√©rico e n√≠vel (opcional)
      $score.textContent = safeNum(scoreObj?.score, 2);
  
      // Campos do breakdown
      $sev.textContent  = safeNum(breakdown?.severity, 2);
      $dur.textContent  = safeNum(breakdown?.duration, 2);
      $freq.textContent = safeNum(breakdown?.frequency, 2);
      $imp.textContent  = safeNum(breakdown?.impact, 2);
    }
  </script>
<script>
/* ============ Helpers (cria s√≥ se ainda n√£o existirem) ============ */
window.safeNum ||= function(n, d = 2) {
  return (typeof n === "number" && isFinite(n)) ? n.toFixed(d) : "‚Äî";
};

window.pickScoreBundle ||= function(api) {
  const scoreObj =
    api?.score ??
    api?.result?.score ??
    api?.persisted?.score ?? null;

  const breakdown =
    scoreObj?.breakdown ??
    api?.alert_obs ??
    api?.score?.alert_obs ?? null;

  return { scoreObj, breakdown };
};

window.renderAnalysis ||= function(api) {
  const { scoreObj, breakdown } = pickScoreBundle(api);
  const $score = document.getElementById("scoreValue");
  const $sev   = document.getElementById("sevValue");
  const $dur   = document.getElementById("durValue");
  const $freq  = document.getElementById("freqValue");
  const $imp   = document.getElementById("impValue");
  if (!$score || !$sev || !$dur || !$freq || !$imp) return;

  if (!scoreObj && !breakdown) {
    $score.textContent = $sev.textContent =
    $dur.textContent   = $freq.textContent =
    $imp.textContent   = "‚Äî";
    return;
  }
  $score.textContent = safeNum(scoreObj?.score, 2);
  $sev.textContent   = safeNum(breakdown?.severity, 2);
  $dur.textContent   = safeNum(breakdown?.duration, 2);
  $freq.textContent  = safeNum(breakdown?.frequency, 2);
  $imp.textContent   = safeNum(breakdown?.impact, 2);
};

window.getWaterValue ||= function(api) {
  const v1 = api?.score?.alert_obs?.meta?.precipitation;
  const v2 = api?.weather?.precipitation;
  const v3 = api?.water?.precipitation;
  const raw = (v1 ?? v2 ?? v3);
  if (raw === null || raw === undefined || Number.isNaN(Number(raw))) return null;
  const n = Number(raw);
  return Number.isFinite(n) ? n : null;
};

window.renderWater ||= function(api) {
  const val = getWaterValue(api);
  const $aguaValue = document.getElementById("aguaValue");
  const $aguaBadge = document.getElementById("aguaBadge");
  if (!$aguaValue) return;

  if (val === null) {
    $aguaValue.textContent = "Sem dados";
    if ($aguaBadge) $aguaBadge.textContent = "‚Äî";
    return;
  }
  $aguaValue.textContent = `${val.toFixed(1)} mm`;
  if ($aguaBadge) {
    let label = "Baixo";
    if (val >= 50) label = "Cr√≠tico";
    else if (val >= 20) label = "Alto";
    else if (val >= 5) label = "Moderado";
    $aguaBadge.textContent = label;
  }
};

/* ============ Hook de fetch (n√£o-intrusivo) ============ */
/* Intercepta chamadas √† API principal, clona a resposta JSON e dispara os renders.
   N√£o altera teu fluxo nem layout. */
(function attachAnalysisHook(){
  const ORIG_FETCH = window.fetch.bind(window);
  window.fetch = async function(input, init) {
    const res = await ORIG_FETCH(input, init);
    try {
      const url = typeof input === 'string' ? input : input?.url;
      if (url && url.includes('/api/alertas_update')) {
        const clone = res.clone();
        // pode falhar se n√£o for JSON ‚Äî por isso o try isolado
        const data = await clone.json();
        renderAnalysis(data);
        renderWater(data);
      }
    } catch (e) {
      console.warn('Hook an√°lise: n√£o deu pra ler JSON da resposta', e);
    }
    return res; // mant√©m o comportamento original
  };
})();
</script>

</body>
</html>
