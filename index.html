<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>AmazonSafe – Mapa e Alertas</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            c1: '#10b981',       // green-500
            c2: '#064e3b',       // green-900
            'ok-status': '#10b981',
            'alert-status': '#f59e0b',
            'crit-status': '#b91c1c',
          }
        }
      }
    }
  </script>

  <!-- Chart.js (para histórico) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    #map { height: 70vh; min-height: 380px; }
    .dash { max-height: calc(100vh - 110px); }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

<!-- HEADER (banner + controles) -->
<header class="sticky top-0 z-20 border-b border-gray-200 bg-white">
  <div class="mx-auto max-w-7xl px-4 py-3">
    <div class="flex items-center gap-4 flex-wrap">
      <!-- Marca -->
      <div class="flex items-center gap-4 min-w-[320px]">
        <img src="assets/logo.png" alt="AmazonSafe" class="h-14 w-auto object-contain">
        <div>
          <div class="text-2xl font-extrabold text-gray-900">
            Amazon<span class="text-c1">Safe</span>
          </div>
          <div class="text-sm text-gray-600 -mt-0.5">Monitoramento Ambiental Inteligente</div>
        </div>

        <span class="ml-2 text-xs bg-indigo-50 text-indigo-900 px-3 py-1 rounded-full">
          API: amazonsafe-api.onrender.com
        </span>
      </div>

      <!-- Controles -->
      <div class="ml-auto flex gap-2 flex-wrap">
        <input id="cidade" placeholder="Cidade (ex: Belém-PA)" class="p-2 border border-gray-300 rounded-lg min-w-[180px] focus:outline-none focus:ring-2 focus:ring-c1" />
        <input id="lat" type="number" step="0.0001" placeholder="Lat" class="p-2 border border-gray-300 rounded-lg w-28 focus:outline-none focus:ring-2 focus:ring-c1" />
        <input id="lon" type="number" step="0.0001" placeholder="Lon" class="p-2 border border-gray-300 rounded-lg w-28 focus:outline-none focus:ring-2 focus:ring-c1" />
        <button id="btnGo" class="p-2 px-4 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-lg transition disabled:opacity-60 disabled:cursor-progress">
          Buscar & Analisar
        </button>
      </div>
    </div>
  </div>
</header>

<!-- LAYOUT -->
<main class="mx-auto max-w-7xl p-3 lg:p-4 grid lg:grid-cols-3 gap-3">

  <!-- KPIs (dinâmicos com breakdown) -->
  <section class="lg:col-span-3">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <!-- Severity -->
      <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
        <div id="kpiBarSeverity" class="h-1 bg-gray-200"></div>
        <div class="p-4">
          <p class="text-xs font-semibold uppercase text-gray-500">Gravidade (severity)</p>
          <p id="kpiSeverityText" class="text-3xl font-bold text-gray-900 mt-1">—</p>
          <span id="kpiSeverityBadge" class="inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full mt-2 bg-gray-100 text-gray-700">—</span>
        </div>
      </div>
      <!-- Duration -->
      <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
        <div id="kpiBarDuration" class="h-1 bg-gray-200"></div>
        <div class="p-4">
          <p class="text-xs font-semibold uppercase text-gray-500">Duração (duration)</p>
          <p id="kpiDurationText" class="text-3xl font-bold text-gray-900 mt-1">—</p>
          <span id="kpiDurationBadge" class="inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full mt-2 bg-gray-100 text-gray-700">—</span>
        </div>
      </div>
      <!-- Frequency -->
      <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
        <div id="kpiBarFrequency" class="h-1 bg-gray-200"></div>
        <div class="p-4">
          <p class="text-xs font-semibold uppercase text-gray-500">Frequência</p>
          <p id="kpiFrequencyText" class="text-3xl font-bold text-gray-900 mt-1">—</p>
          <span id="kpiFrequencyBadge" class="inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full mt-2 bg-gray-100 text-gray-700">—</span>
        </div>
      </div>
      <!-- Impact -->
      <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
        <div id="kpiBarImpact" class="h-1 bg-gray-200"></div>
        <div class="p-4">
          <p class="text-xs font-semibold uppercase text-gray-500">Impacto</p>
          <p id="kpiImpactText" class="text-3xl font-bold text-gray-900 mt-1">—</p>
          <span id="kpiImpactBadge" class="inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full mt-2 bg-gray-100 text-gray-700">—</span>
        </div>
      </div>
    </div>
  </section>

  <!-- MAPA -->
  <section id="mapWrap" class="lg:col-span-2 bg-white border border-gray-200 rounded-xl shadow overflow-hidden">
    <div id="map"></div>
  </section>

  <!-- DASHBOARD -->
  <aside class="dash lg:col-span-1 flex flex-col gap-4 overflow-y-auto pr-1">

    <!-- Histórico (Chart.js) -->
    <div class="bg-white p-4 border border-gray-200 rounded-xl shadow">
      <h3 class="text-lg font-semibold text-gray-800 mb-3">Histórico de Risco</h3>
      <div class="h-40">
        <canvas id="riscoHistorico"></canvas>
      </div>
    </div>

    <!-- Resultado da análise -->
    <div class="bg-white p-4 border border-gray-200 rounded-xl shadow">
      <div class="flex items-center gap-3 flex-wrap">
        <strong class="text-xl font-bold text-gray-900">Resultado da análise</strong>
        <span id="nivelPill" class="hidden px-3 py-1 text-sm font-bold rounded-full">—</span>
      </div>
      <div id="metaBox" class="text-gray-500 text-xs mt-2">Local: <strong>—</strong> • Última observação: <strong>—</strong></div>

      <div class="grid grid-cols-2 gap-2 mt-4">
        <div class="bg-gray-100 border border-gray-200 rounded-lg p-3">
          <b class="block text-xs text-gray-600 mb-1">Score (0–1)</b>
          <div id="scoreVal" class="text-xl font-mono text-gray-900">—</div>
        </div>
        <div class="bg-gray-100 border border-gray-200 rounded-lg p-3">
          <b class="block text-xs text-gray-600 mb-1">Thresholds</b>
          <div id="thresholds" class="text-xs font-mono text-gray-600">verde &lt; 0.33 • amarelo 0.33–0.66 • vermelho ≥ 0.66</div>
        </div>
        <div class="bg-gray-100 border border-gray-200 rounded-lg p-3">
          <b class="block text-xs text-gray-600 mb-1">Severity</b>
          <div id="sevVal" class="text-base font-mono text-gray-800">—</div>
        </div>
        <div class="bg-gray-100 border border-gray-200 rounded-lg p-3">
          <b class="block text-xs text-gray-600 mb-1">Duration</b>
          <div id="durVal" class="text-base font-mono text-gray-800">—</div>
        </div>
        <div class="bg-gray-100 border border-gray-200 rounded-lg p-3">
          <b class="block text-xs text-gray-600 mb-1">Frequency</b>
          <div id="freqVal" class="text-base font-mono text-gray-800">—</div>
        </div>
        <div class="bg-gray-100 border border-gray-200 rounded-lg p-3">
          <b class="block text-xs text-gray-600 mb-1">Impact</b>
          <div id="impVal" class="text-base font-mono text-gray-800">—</div>
        </div>
      </div>

      <pre id="resumoBox" class="whitespace-pre-wrap text-sm mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-700"></pre>
    </div>

    <!-- Últimos alertas -->
    <div class="bg-white p-4 border border-gray-200 rounded-xl shadow">
      <div class="flex justify-between items-center gap-2">
        <strong class="text-lg font-semibold text-gray-900">Últimos alertas</strong>
        <span class="text-xs text-gray-500">• círculo menor = foco fraco</span>
      </div>
      <pre id="alertasBox" class="whitespace-pre-wrap text-xs mt-3 bg-gray-50 border border-gray-200 rounded-lg p-2"></pre>
    </div>
  </aside>
</main>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
  const API = "https://amazonsafe-api.onrender.com";

  // ---- DOM
  const elCidade = document.querySelector('#cidade');
  const elLat = document.querySelector('#lat');
  const elLon = document.querySelector('#lon');
  const btnGo = document.querySelector('#btnGo');
  const resumoBox = document.querySelector('#resumoBox');
  const alertasBox = document.querySelector('#alertasBox');
  const metaBox = document.querySelector('#metaBox');
  const nivelPill = document.querySelector('#nivelPill');

  const scoreVal = document.querySelector('#scoreVal');
  const sevVal = document.querySelector('#sevVal');
  const durVal = document.querySelector('#durVal');
  const freqVal = document.querySelector('#freqVal');
  const impVal = document.querySelector('#impVal');

  // KPI elements
  const kpi = {
    severity: {text: document.querySelector('#kpiSeverityText'), badge: document.querySelector('#kpiSeverityBadge'), bar: document.querySelector('#kpiBarSeverity')},
    duration: {text: document.querySelector('#kpiDurationText'), badge: document.querySelector('#kpiDurationBadge'), bar: document.querySelector('#kpiBarDuration')},
    frequency:{text: document.querySelector('#kpiFrequencyText'),badge: document.querySelector('#kpiFrequencyBadge'), bar: document.querySelector('#kpiBarFrequency')},
    impact:   {text: document.querySelector('#kpiImpactText'),   badge: document.querySelector('#kpiImpactBadge'),   bar: document.querySelector('#kpiBarImpact')}
  };

  // ---- Mapa
  const map = L.map('map').setView([-3.1, -60.0], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  let focosLayer = L.layerGroup().addTo(map);

  // ---- Chart.js (histórico real a partir da API)
  let riscoChart = null;
  async function setupChartFromAPI() {
    try {
      const data = await fetchJson(`${API}/api/alertas?limit=30`);
      const items = Array.isArray(data?.items) ? data.items : [];
      const labels = items.map(i => (i.ts || '').slice(5,10)); // "MM-DD"
      const values = items.map(i => (typeof i.score === 'number' ? i.score : i.score?.score ?? null)).filter(v => v !== null);

      const ctx = document.getElementById('riscoHistorico').getContext('2d');
      if (riscoChart) riscoChart.destroy();
      riscoChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Score de Risco',
            data: values,
            borderColor: 'rgb(6,78,59)',
            backgroundColor: 'rgba(245,158,11,0.35)',
            tension: 0.3,
            fill: true,
            pointRadius: 3,
            pointHoverRadius: 5,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {min: 0, max: 1, title: {display: true, text: 'Score'}},
            x: {grid: {display: false}}
          },
          plugins: {legend: {display: false}}
        }
      });
    } catch (e) {
      console.error(e);
    }
  }

  // ---- Helpers
  function setLoading(on) {
    btnGo.disabled = on;
    document.body.classList.toggle('cursor-progress', on);
    if (on) btnGo.classList.add('opacity-60'); else btnGo.classList.remove('opacity-60');
  }

  function classifyByScore(score) {
    if (typeof score !== 'number') return {level:'N/A', cls:'bg-gray-100 text-gray-800', emoji:'⚪'};
    if (score < 0.33)  return {level:'VERDE',   cls:'bg-green-100 text-green-800',  emoji:'🟢'};
    if (score < 0.66)  return {level:'AMARELO', cls:'bg-amber-100 text-amber-800',  emoji:'🟡'};
    return                {level:'VERMELHO', cls:'bg-red-100 text-red-700',    emoji:'🔴'};
  }

  function fmt(v){ return (typeof v === 'number') ? v.toFixed(2) : '—'; }

  function colorForKPI(v){
    if (typeof v !== 'number') return {badge:'bg-gray-100 text-gray-700', bar:'bg-gray-200'};
    if (v < .33) return {badge:'bg-green-100 text-green-700', bar:'bg-green-500'};
    if (v < .66) return {badge:'bg-amber-100 text-amber-700', bar:'bg-amber-500'};
    return {badge:'bg-red-100 text-red-700', bar:'bg-red-600'};
  }

  async function fetchJson(url, opts) {
    const r = await fetch(url, opts);
    if (!r.ok) {
      const text = await r.text().catch(()=> '');
      throw new Error(`HTTP ${r.status} ${r.statusText} – ${text?.slice(0,200)}`);
    }
    return r.json();
  }

  function getParamsFromUI() {
    const cidade = elCidade.value.trim();
    const lat = parseFloat(elLat.value);
    const lon = parseFloat(elLon.value);
    if (cidade) return { cidade };
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
      throw new Error("Informe a cidade **ou** latitude/longitude válidos.");
    }
    return { lat, lon };
  }

  function extractCoords(resp, fallback){
    if (resp?.params?.lat && resp?.params?.lon) return { lat: resp.params.lat, lon: resp.params.lon };
    if (resp?.lat && resp?.lon) return { lat: resp.lat, lon: resp.lon };
    if (resp?.resolve?.lat && resp?.resolve?.lon) return { lat: resp.resolve.lat, lon: resp.resolve.lon };
    return fallback;
  }

  async function carregarFocos(params) {
    focosLayer.clearLayers();
    const qs = new URLSearchParams({ scope: "diario", region: "Brasil", limit: 300, ...params }).toString();
    const data = await fetchJson(`${API}/api/inpe/focos?${qs}`);
    const focos = (data.features && data.features.focos) || [];

    focos.forEach(f => {
      const m = L.circleMarker([f.latitude, f.longitude], {
        radius: Math.max(3, Math.min(12, (f.frp || 1) / 8)),
        color: '#b91c1c', weight: 1, fillOpacity: 0.75
      }).bindPopup(`
        <div><strong>${f.municipio || ''} - ${f.uf || ''}</strong></div>
        <div>Satélite: ${f.satelite || '-'}</div>
        <div>FRP: ${f.frp ?? '-'}</div>
        <div>Bioma: ${f.bioma || '-'}</div>
      `);
      m.addTo(focosLayer);
    });

    if (focos.length) {
      const bounds = L.latLngBounds(focos.map(f => [f.latitude, f.longitude]));
      map.fitBounds(bounds.pad(0.2));
    }
    return { count: focos.length, params };
  }

  // ---- Fluxo principal
  async function executar() {
    setLoading(true);
    resumoBox.className = 'whitespace-pre-wrap text-sm mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-700';
    try {
      const uiParams = getParamsFromUI();

      // 1) Análise (usa geocodificação do backend)
      resumoBox.textContent = "Processando análise...";
      const data = await fetchJson(`${API}/api/alertas_update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ...uiParams,
          scope: "diario",
          region: "Brasil",
          raio_km: 150,
          air_radius_m: 10000,
          weather_provider: "open-meteo"
        })
      });

      // 2) Calcular nível a partir do score (garante consistência)
      const scoreNum = (typeof data?.score?.score === 'number') ? data.score.score : null;
      const lv = classifyByScore(scoreNum);
      nivelPill.className = `px-3 py-1 text-sm font-bold rounded-full ${lv.cls}`;
      nivelPill.textContent = `${lv.emoji} ${lv.level}`;
      nivelPill.classList.remove('hidden');

      // Metadados
      const resolved = data?.params?.resolve?.display_name || data?.params?.cidade || elCidade.value.trim();
      const when = data?.score?.alert_obs?.meta?.observed_at || data?.observed_at || '';
      metaBox.innerHTML = `Local: <strong>${resolved || '—'}</strong> • Última observação: <strong>${when || '—'}</strong>`;

      // 3) Score e breakdown
      const br = data?.score?.breakdown || {};
      scoreVal.textContent = fmt(scoreNum);
      sevVal.textContent   = fmt(br.severity);
      durVal.textContent   = fmt(br.duration);
      freqVal.textContent  = fmt(br.frequency);
      impVal.textContent   = fmt(br.impact);

      // KPIs com cores
      const sC = colorForKPI(br.severity);   kpi.severity.text.textContent = fmt(br.severity);   kpi.severity.badge.className = `inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full mt-2 ${sC.badge}`;  kpi.severity.badge.textContent='•'; kpi.severity.bar.className = `h-1 ${sC.bar}`;
      const dC = colorForKPI(br.duration);   kpi.duration.text.textContent = fmt(br.duration);   kpi.duration.badge.className = `inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full mt-2 ${dC.badge}`;  kpi.duration.badge.textContent='•'; kpi.duration.bar.className = `h-1 ${dC.bar}`;
      const fC = colorForKPI(br.frequency);  kpi.frequency.text.textContent= fmt(br.frequency);  kpi.frequency.badge.className= `inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full mt-2 ${fC.badge}`;  kpi.frequency.badge.textContent='•'; kpi.frequency.bar.className = `h-1 ${fC.bar}`;
      const iC = colorForKPI(br.impact);     kpi.impact.text.textContent   = fmt(br.impact);     kpi.impact.badge.className   = `inline-flex items-center text-xs font-medium px-2.5 py-0.5 rounded-full mt-2 ${iC.badge}`;   kpi.impact.badge.textContent='•'; kpi.impact.bar.className = `h-1 ${iC.bar}`;

      // 4) Focos
      const coords = extractCoords(data, uiParams);
      const res = await carregarFocos(coords);
      resumoBox.classList.add('text-green-700', 'font-semibold');
      resumoBox.textContent = `Focos plotados: ${res.count}\nFonte: INPE (CSV)\nParams: ${JSON.stringify(coords, null, 2)}`;

      // 5) Últimos alertas + gráfico histórico
      await carregarUltimosAlertas();
      await setupChartFromAPI();

    } catch (err) {
      resumoBox.classList.add('text-red-700', 'font-semibold');
      resumoBox.textContent = `Erro: ${err.message}`;
      scoreVal.textContent = sevVal.textContent = durVal.textContent = freqVal.textContent = impVal.textContent = '—';
      console.error(err);
    } finally {
      setLoading(false);
    }
  }

  async function carregarUltimosAlertas() {
    try {
      alertasBox.textContent = "Carregando últimos alertas...";
      const data = await fetchJson(`${API}/api/alertas?limit=5`);
      alertasBox.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      alertasBox.textContent = `Erro ao carregar alertas: ${err.message}`;
    }
  }

  // Eventos
  btnGo.addEventListener('click', executar);
  elCidade.addEventListener('keydown', (e) => { if (e.key === 'Enter') executar(); });

  // Inicial
  carregarUltimosAlertas();
  setupChartFromAPI();
</script>
</body>
</html>
