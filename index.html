<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>AmazonSafe â€“ Mapa e Alertas</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root{
      --c1:#0d9488; /* teal */
      --c2:#0f172a; /* slate-900 */
      --bg:#f8fafc; /* slate-50 */
      --card:#ffffff;
      --muted:#64748b;
      --ok:#065f46;
      --err:#b91c1c;
      --border:#e2e8f0;
    }
    *{box-sizing:border-box}
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--c2);}
    header {
      position:sticky; top:0; z-index:10;
      padding: 10px 14px; border-bottom: 1px solid var(--border);
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; background:#fff;
    }
    input, button {
      padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff;
    }
    input{min-width: 160px;}
    button { background:var(--c1); color:#fff; border:none; cursor:pointer; font-weight:600; }
    button:disabled{opacity:.6; cursor:progress}
    .badge { padding:4px 10px; border-radius:999px; background:#eef; font-size:12px; color:#334155; }

    /* --- Layout principal: mapa Ã  esquerda, dashboard Ã  direita --- */
    .layout{
      display:grid; gap:12px; padding:12px; align-items:start;
      grid-template-columns: 1.7fr 1fr;
    }
    @media (max-width: 1000px){
      .layout{ grid-template-columns: 1fr; }
    }

    /* Mapa ocupa ~70vh por padrÃ£o; ajusta no mobile */
    #mapWrap{ background:#fff; border:1px solid var(--border); border-radius:14px; overflow:hidden; }
    #map { height: 70vh; min-height: 380px; }

    .dash{
      display:flex; flex-direction:column; gap:12px;
      max-height: calc(100dvh - 110px); /* debaixo do header */
      overflow:auto; padding-right:4px;
    }
    .card { padding:14px; border:1px solid var(--border); border-radius:14px; background:var(--card); box-shadow:0 1px 2px rgba(2,6,23,.04);}
    .muted { color:var(--muted) }
    .loading { cursor: progress; opacity: .85 }
    .error { color:var(--err) }
    .ok { color:var(--ok) }
    .legend{font-size:12px;color:#334155}

    .pill {
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      font-weight:700; letter-spacing:.2px;
      border:1px solid transparent;
    }
    .pill.green{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0 }
    .pill.yellow{ background:#fffbeb; color:#92400e; border-color:#fde68a }
    .pill.red{ background:#fef2f2; color:#991b1b; border-color:#fecaca }

    .kvs{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .kv{ background:#f1f5f9; border:1px solid var(--border); border-radius:10px; padding:10px; }
    .kv b{ display:block; font-size:12px; color:#334155; margin-bottom:6px; }
    .kv .v{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    pre { margin:0 }
  </style>
</head>
<body>
<header style="
  position:sticky; top:0; z-index:10;
  display:flex; align-items:center; gap:18px; flex-wrap:wrap;
  padding:16px 20px; border-bottom:1px solid #e2e8f0; background:#fff;
">
  <!-- Marca (logo + texto) -->
  <div style="display:flex; align-items:center; gap:14px; min-width:260px">
    <img src="assets/logo.svg" alt="AmazonSafe logo" style="height:86px" />
    <div>
      <div style="font-size:18px; font-weight:800; color:#0f172a">AmazonSafe</div>
      <div style="font-size:14px; color:#475569; margin-top:2px">
        Monitoramento Ambiental Inteligente
      </div>
    </div>
    <span class="badge" style="margin-left:8px">API: amazonsafe-api.onrender.com</span>
  </div>

  <!-- Controles (mantÃ©m os mesmos IDs usados no JS) -->
  <div style="margin-left:auto; display:flex; gap:10px; flex-wrap:wrap">
    <input id="cidade" placeholder="Cidade (ex: BelÃ©m-PA)" />
    <input id="lat" type="number" step="0.0001" placeholder="Lat" style="width:120px" />
    <input id="lon" type="number" step="0.0001" placeholder="Lon" style="width:120px" />
    <button id="btnGo" title="Geocodifica + AnÃ¡lise + Focos">Buscar & Analisar</button>
  </div>
</header>



<main class="layout">
  <!-- Coluna esquerda: MAPA -->
  <section id="mapWrap">
    <div id="map"></div>
  </section>

  <!-- Coluna direita: DASHBOARD -->
  <aside class="dash">
    <div class="card">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <strong style="font-size:16px">Resultado da anÃ¡lise</strong>
        <span id="nivelPill" class="pill green" style="display:none">â€”</span>
      </div>
      <div id="metaBox" class="muted" style="font-size:12px;margin-top:6px"></div>

      <!-- Score numÃ©rico + breakdown -->
      <div class="kvs" style="margin-top:10px">
        <div class="kv">
          <b>Score (0â€“1)</b>
          <div id="scoreVal" class="v">â€”</div>
        </div>
        <div class="kv">
          <b>Thresholds</b>
          <div class="v" id="thresholds">verde &lt; 0.33 â€¢ amarelo 0.33â€“0.66 â€¢ vermelho â‰¥ 0.66</div>
        </div>
        <div class="kv">
          <b>Severity</b>
          <div id="sevVal" class="v">â€”</div>
        </div>
        <div class="kv">
          <b>Duration</b>
          <div id="durVal" class="v">â€”</div>
        </div>
        <div class="kv">
          <b>Frequency</b>
          <div id="freqVal" class="v">â€”</div>
        </div>
        <div class="kv">
          <b>Impact</b>
          <div id="impVal" class="v">â€”</div>
        </div>
      </div>

      <!-- Resumo textual -->
      <pre id="resumoBox" style="white-space:pre-wrap; font-size:12px; margin:12px 0 0"></pre>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <strong>Ãšltimos alertas</strong>
        <span class="legend">â€¢ cÃ­rculo menor = foco fraco â€¢ maior = foco forte</span>
      </div>
      <pre id="alertasBox" style="white-space:pre-wrap; font-size:12px; margin:8px 0 0"></pre>
    </div>
  </aside>
</main>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script>
  const API = "https://amazonsafe-api.onrender.com";

  // Mapa
  const map = L.map('map').setView([-3.1, -60.0], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  let focosLayer = L.layerGroup().addTo(map);

  // DOM
  const elCidade = document.querySelector('#cidade');
  const elLat = document.querySelector('#lat');
  const elLon = document.querySelector('#lon');
  const btnGo = document.querySelector('#btnGo');
  const resumoBox = document.querySelector('#resumoBox');
  const alertasBox = document.querySelector('#alertasBox');
  const metaBox = document.querySelector('#metaBox');
  const nivelPill = document.querySelector('#nivelPill');

  const scoreVal = document.querySelector('#scoreVal');
  const sevVal   = document.querySelector('#sevVal');
  const durVal   = document.querySelector('#durVal');
  const freqVal  = document.querySelector('#freqVal');
  const impVal   = document.querySelector('#impVal');

  function setLoading(on) {
    [btnGo].forEach(b => b.disabled = on);
    document.body.classList.toggle('loading', on);
  }

  function pill(level){
    const lv = (level||'').toLowerCase();
    nivelPill.style.display = 'inline-flex';
    nivelPill.className = 'pill ' + (lv.startsWith('ver')     ? 'green'
                                   : lv.startsWith('ama')     ? 'yellow'
                                   : lv.startsWith('verme')   ? 'red'
                                   : 'green');
    const emoji = lv.startsWith('ver') ? 'ðŸŸ¢' : lv.startsWith('ama') ? 'ðŸŸ¡' : lv.startsWith('verme') ? 'ðŸ”´' : 'âšª';
    nivelPill.textContent = `${emoji} ${level?.toUpperCase?.() || 'N/A'}`;
  }

  async function fetchJson(url, opts) {
    const r = await fetch(url, opts);
    if (!r.ok) {
      const text = await r.text().catch(() => '');
      throw new Error(`HTTP ${r.status} ${r.statusText} â€“ ${text?.slice(0,200)}`);
    }
    return r.json();
  }

  function getParamsFromUI() {
    const cidade = elCidade.value.trim();
    const lat = parseFloat(elLat.value);
    const lon = parseFloat(elLon.value);
    if (cidade) return { cidade };
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
      throw new Error("Informe a cidade **ou** latitude/longitude vÃ¡lidos.");
    }
    return { lat, lon };
  }

  function extractCoords(resp, fallback){
    if (resp?.params?.lat && resp?.params?.lon) return { lat: resp.params.lat, lon: resp.params.lon };
    if (resp?.lat && resp?.lon) return { lat: resp.lat, lon: resp.lon };
    if (resp?.resolve?.lat && resp?.resolve?.lon) return { lat: resp.resolve.lat, lon: resp.resolve.lon };
    return fallback;
  }

  // Plota focos do INPE
  async function carregarFocos(params) {
    focosLayer.clearLayers();
    const qs = new URLSearchParams({ scope: "diario", region: "Brasil", limit: 300, ...params }).toString();
    const data = await fetchJson(`${API}/api/inpe/focos?${qs}`);
    const focos = (data.features && data.features.focos) || [];

    focos.forEach(f => {
      const m = L.circleMarker([f.latitude, f.longitude], {
        radius: Math.max(3, Math.min(12, (f.frp || 1) / 8)),
        color: '#ef4444', weight: 1, fillOpacity: 0.65
      }).bindPopup(`
        <div><strong>${f.municipio || ''} - ${f.uf || ''}</strong></div>
        <div>SatÃ©lite: ${f.satelite || '-'}</div>
        <div>FRP: ${f.frp ?? '-'}</div>
        <div>Bioma: ${f.bioma || '-'}</div>
      `);
      m.addTo(focosLayer);
    });

    if (focos.length) {
      const bounds = L.latLngBounds(focos.map(f => [f.latitude, f.longitude]));
      map.fitBounds(bounds.pad(0.2));
    }
    return { count: focos.length, params };
  }

  // Fluxo Ãºnico: geocodifica + roda anÃ¡lise + plota focos
  async function executar() {
    setLoading(true);
    resumoBox.className = '';
    try {
      const uiParams = getParamsFromUI();

      // 1) AnÃ¡lise (usa geocodificaÃ§Ã£o do backend)
      resumoBox.textContent = "Processando anÃ¡lise...";
      const data = await fetchJson(`${API}/api/alertas_update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ...uiParams,
          scope: "diario",
          region: "Brasil",
          raio_km: 150,
          air_radius_m: 10000,
          weather_provider: "open-meteo"
        })
      });

      // 2) NÃ­vel e metadados
      pill(data?.score?.level || 'n/a');
      const resolved = data?.params?.resolve?.display_name || data?.params?.cidade || elCidade.value.trim();
      const when = data?.score?.alert_obs?.meta?.observed_at || data?.observed_at || '';
      metaBox.innerHTML = `Local: <strong>${resolved || 'â€”'}</strong> â€¢ Ãšltima observaÃ§Ã£o: <strong>${when || 'â€”'}</strong>`;

      // 3) Score e breakdown (NOVO)
      const s  = typeof data?.score?.score === 'number' ? data.score.score : null;
      const br = data?.score?.breakdown || {};
      scoreVal.textContent = (s ?? 'â€”');
      sevVal.textContent   = (br.severity  ?? 'â€”');
      durVal.textContent   = (br.duration  ?? 'â€”');
      freqVal.textContent  = (br.frequency ?? 'â€”');
      impVal.textContent   = (br.impact    ?? 'â€”');

      // 4) Focos, usando coords retornadas
      const coords = extractCoords(data, uiParams);
      const res = await carregarFocos(coords);

      resumoBox.className = 'ok';
      resumoBox.textContent =
        `Focos plotados: ${res.count}\nFonte: INPE (CSV)\nParams: ${JSON.stringify(coords)}`;

      // 5) Ãšltimos alertas
      await carregarUltimosAlertas();
    } catch (err) {
      resumoBox.className = 'error';
      resumoBox.textContent = `Erro: ${err.message}`;
      scoreVal.textContent = sevVal.textContent = durVal.textContent = freqVal.textContent = impVal.textContent = 'â€”';
      console.error(err);
    } finally {
      setLoading(false);
    }
  }

  async function carregarUltimosAlertas() {
    try {
      alertasBox.textContent = "Carregando Ãºltimos alertas...";
      const data = await fetchJson(`${API}/api/alertas?limit=5`);
      alertasBox.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      alertasBox.textContent = `Erro ao carregar alertas: ${err.message}`;
    }
  }

  btnGo.addEventListener('click', executar);
  elCidade.addEventListener('keydown', (e)=>{ if(e.key==='Enter') executar(); });

  // Inicial
  carregarUltimosAlertas();
</script>
</body>
</html>
