<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AmazonSafe – Monitoramento Ambiental Inteligente</title>
  <!-- Tailwind CDN (se você já usa build próprio, pode remover esta linha) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- HEADER -->
  <header class="sticky top-0 z-20 bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4 flex-wrap">
      <!-- Bloco: logo + marca + badge API -->
      <div class="flex items-center gap-4 min-w-[280px]">
        <!-- LOGO -->
        <img src="assets/logo.png" alt="AmazonSafe" class="h-[100px] w-[100px] rounded-full object-cover" />

        <!-- Marca -->
        <div class="flex flex-col">
          <div class="text-4xl font-extrabold leading-tight">
            Amazon<span class="text-emerald-600">Safe</span>
          </div>
          <!-- subtítulo MENOR (ajuste aqui se quiser xs/sm/base) -->
          <div class="text-sm text-gray-600 -mt-1">
            Monitoramento Ambiental Inteligente
          </div>
        </div>

        <!-- Badge da API AO LADO (não embaixo) -->
        <span class="ml-3 text-xs bg-indigo-50 text-indigo-700 px-2.5 py-1 rounded-full">
          API: amazonsafe-api.onrender.com
        </span>
      </div>

      <!-- Busca -->
      <div class="ml-auto flex gap-2 flex-wrap">
        <input id="cidade" placeholder="Cidade (ex: Belém, PA)"
               class="p-2 border border-gray-300 rounded-lg min-w-[210px] text-gray-800" />
        <input id="lat" type="number" step="0.0001" placeholder="Lat"
               class="p-2 border border-gray-300 rounded-lg w-28 text-gray-800" />
        <input id="lon" type="number" step="0.0001" placeholder="Lon"
               class="p-2 border border-gray-300 rounded-lg w-28 text-gray-800" />
        <button id="btnGo"
                class="p-2 px-4 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-lg transition duration-150 disabled:opacity-60 disabled:cursor-not-allowed">
          Buscar & Analisar
        </button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- META / NÍVEL -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="p-4 bg-white rounded-xl border">
        <div class="text-xs text-gray-500">Nível</div>
        <div class="mt-1">
          <span id="nivelPill" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700">—</span>
        </div>
      </div>
      <div class="p-4 bg-white rounded-xl border md:col-span-2">
        <div class="text-xs text-gray-500">Meta</div>
        <div id="metaBox" class="mt-1 text-sm text-gray-700">
          Local: <strong>—</strong> • Última observação: <strong>—</strong>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid md:grid-cols-3 gap-4">
      <!-- KPI ÁGUA -->
      <div class="p-4 bg-white rounded-xl border">
        <div class="text-base text-gray-600 uppercase">Água (chuva/cheia)</div>
        <div class="mt-2 text-4xl font-extrabold text-emerald-700" id="aguaValue">Sem dados</div>
        <div class="mt-1">
          <span id="aguaBadge" class="text-xs px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700">—</span>
        </div>
      </div>

      <!-- KPI AR (placeholder) -->
      <div class="p-4 bg-white rounded-xl border">
        <div class="text-base text-gray-600 uppercase">Ar (qualidade)</div>
        <div class="mt-2 text-4xl font-extrabold text-sky-700" id="arValue">Sem dados</div>
        <div class="mt-1">
          <span id="arBadge" class="text-xs px-2 py-0.5 rounded-full bg-sky-50 text-sky-700">—</span>
        </div>
      </div>

      <!-- KPI FOGO (placeholder) -->
      <div class="p-4 bg-white rounded-xl border">
        <div class="text-base text-gray-600 uppercase">Fogo (focos/incêndio)</div>
        <div class="mt-2 text-4xl font-extrabold text-red-700" id="fogoValue">Sem dados</div>
        <div class="mt-1">
          <span id="fogoBadge" class="text-xs px-2 py-0.5 rounded-full bg-red-50 text-red-700">—</span>
        </div>
      </div>
    </section>

    <!-- RESULTADO DA ANÁLISE -->
    <section class="p-4 bg-white rounded-xl border">
      <div class="flex items-center gap-2">
        <h2 class="text-lg font-bold">Resultado da análise</h2>
        <span class="text-xs text-gray-500">(score 0–1)</span>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mt-3">
        <div class="p-3 border rounded-lg">
          <div class="text-xs text-gray-500">Score</div>
          <div class="text-xl font-bold"><span id="scoreValue">—</span></div>
        </div>
        <div class="p-3 border rounded-lg">
          <div class="text-xs text-gray-500">Thresholds</div>
          <div class="text-sm text-gray-700">
            <span id="threshText">verde &lt; 0.33 • amarelo 0.33–0.66 • vermelho ≥ 0.66</span>
          </div>
        </div>

        <div class="p-3 border rounded-lg">
          <div class="text-xs text-gray-500">Severity</div>
          <div class="text-lg font-semibold"><span id="sevValue">—</span></div>
        </div>
        <div class="p-3 border rounded-lg">
          <div class="text-xs text-gray-500">Duration</div>
          <div class="text-lg font-semibold"><span id="durValue">—</span></div>
        </div>

        <div class="p-3 border rounded-lg">
          <div class="text-xs text-gray-500">Frequency</div>
          <div class="text-lg font-semibold"><span id="freqValue">—</span></div>
        </div>
        <div class="p-3 border rounded-lg">
          <div class="text-xs text-gray-500">Impact</div>
          <div class="text-lg font-semibold"><span id="impValue">—</span></div>
        </div>
      </div>
    </section>
  </main>

  <!-- SCRIPTS -->
  <script>
    // ========= Utils =========
    const API = "https://amazonsafe-api.onrender.com";

    const elCidade = document.getElementById("cidade");
    const elLat    = document.getElementById("lat");
    const elLon    = document.getElementById("lon");

    function get(obj, path, def = undefined) {
      try {
        return path.split('.').reduce((acc, k) => (acc && acc[k] !== undefined) ? acc[k] : undefined, obj) ?? def;
      } catch { return def; }
    }
    function num(v, def = null) {
      const n = Number(v);
      return Number.isFinite(n) ? n : def;
    }
    function safeNum(n, digits = 2) {
      return (typeof n === "number" && isFinite(n)) ? n.toFixed(digits) : "—";
    }
    async function fetchJson(url, init) {
      const r = await fetch(url, init);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    function setNivelPill(level, color) {
      const pill = document.getElementById("nivelPill");
      if (!pill) return;
      pill.textContent = level || "—";
      // cor básica por nível, se a API não fornecer
      const map = {
        verde: ["bg-emerald-50","text-emerald-700"],
        amarelo: ["bg-amber-50","text-amber-700"],
        vermelho: ["bg-rose-50","text-rose-700"]
      };
      const cls = map[(level||"").toLowerCase()] || ["bg-gray-100","text-gray-700"];
      pill.className = `px-2 py-1 text-xs rounded-full ${cls[0]} ${cls[1]}`;
    }

    // ========= Resultado da Análise =========
    function pickScoreBundle(api) {
      const scoreObj =
        api?.score ??
        api?.result?.score ??
        api?.persisted?.score ?? null;

      const breakdown =
        scoreObj?.breakdown ??
        api?.alert_obs ??
        api?.score?.alert_obs ?? null;

      return { scoreObj, breakdown };
    }

    function renderAnalysis(api) {
      const { scoreObj, breakdown } = pickScoreBundle(api);

      const $score = document.getElementById("scoreValue");
      const $sev   = document.getElementById("sevValue");
      const $dur   = document.getElementById("durValue");
      const $freq  = document.getElementById("freqValue");
      const $imp   = document.getElementById("impValue");

      if (!$score || !$sev || !$dur || !$freq || !$imp) {
        console.warn("IDs do painel de análise não encontrados.");
        return;
      }

      if (!scoreObj && !breakdown) {
        $score.textContent = $sev.textContent =
        $dur.textContent   = $freq.textContent =
        $imp.textContent   = "—";
        console.warn("Sem score/breakdown na resposta.");
        return;
      }

      $score.textContent = safeNum(scoreObj?.score, 2);
      $sev.textContent   = safeNum(breakdown?.severity, 2);
      $dur.textContent   = safeNum(breakdown?.duration, 2);
      $freq.textContent  = safeNum(breakdown?.frequency, 2);
      $imp.textContent   = safeNum(breakdown?.impact, 2);
    }

    // ========= KPI Água (aceita zero) =========
    function getWaterValue(api) {
      const v1 = api?.score?.alert_obs?.meta?.precipitation;
      const v2 = api?.weather?.precipitation;
      const v3 = api?.water?.precipitation;
      const raw = (v1 ?? v2 ?? v3);
      if (raw === null || raw === undefined || Number.isNaN(Number(raw))) return null;
      const n = Number(raw);
      return Number.isFinite(n) ? n : null;
    }
    function renderWater(api) {
      const val = getWaterValue(api);
      const $aguaValue = document.getElementById("aguaValue");
      const $aguaBadge = document.getElementById("aguaBadge");
      if (!$aguaValue) return;

      if (val === null) {
        $aguaValue.textContent = "Sem dados";
        if ($aguaBadge) $aguaBadge.textContent = "—";
        return;
      }
      $aguaValue.textContent = `${val.toFixed(1)} mm`;
      if ($aguaBadge) {
        let label = "Baixo";
        if (val >= 50) label = "Crítico";
        else if (val >= 20) label = "Alto";
        else if (val >= 5) label = "Moderado";
        $aguaBadge.textContent = label;
      }
    }

    // ========= Fluxo principal =========
    async function executar() {
      // parâmetros de UI
      const uiParams = {};
      const cidade = elCidade?.value?.trim();
      const lat    = elLat?.value?.trim();
      const lon    = elLon?.value?.trim();

      if (cidade) uiParams.cidade = cidade;
      if (lat)    uiParams.lat    = Number(lat);
      if (lon)    uiParams.lon    = Number(lon);

      // chamada principal (ajuste para GET/POST conforme seu backend)
      const data = await fetchJson(`${API}/api/alertas_update`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          ...uiParams,
          scope: "diario",
          region: "Brasil",
          raio_km: 150,
          air_radius_m: 10000,
          weather_provider: "open-meteo"
        })
      });

      // >>>>> CHAMADAS DE RENDER AQUI <<<<<
      renderAnalysis(data);   // Resultado da análise (score/breakdown)
      renderWater(data);      // KPI Água (aceita zero)

      // nível/meta (mantém como já fazia)
      const level   = get(data, 'score.level', 'N/A');
      const lvColor = get(data, 'score.level_color') || get(data, 'color');
      setNivelPill(level, lvColor);

      const resolved = get(data, 'params.resolve.display_name') ||
                       get(data, 'params.cidade') ||
                       (elCidade?.value?.trim()) || '—';
      const when = get(data, 'score.alert_obs.meta.observed_at') ||
                   get(data, 'observed_at') || '—';
      const metaBox = document.getElementById("metaBox");
      if (metaBox) {
        metaBox.innerHTML = `Local: <strong>${resolved}</strong> • Última observação: <strong>${when}</strong>`;
      }
    }

    // botão
    document.getElementById("btnGo")?.addEventListener("click", () => {
      executar().catch(err => {
        console.error("Falha no fluxo principal:", err);
        // fallback visual mínimo
        renderAnalysis({});
      });
    });
  </script>
</body>
</html>
