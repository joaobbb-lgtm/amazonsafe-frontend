<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>AmazonSafe ‚Äì Mapa e Alertas</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root{
      --c1:#0d9488; /* teal */
      --c2:#0f172a; /* slate-900 */
      --bg:#f8fafc; /* slate-50 */
      --card:#ffffff;
      --muted:#64748b;
      --ok:#065f46;
      --err:#b91c1c;
    }
    *{box-sizing:border-box}
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:#0f172a;}
    header {
      position:sticky; top:0; z-index:10;
      padding: 10px 14px; border-bottom: 1px solid #e2e8f0;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; background:#fff;
    }
    #map { height: calc(100dvh - 210px); }
    .panel { padding: 12px 14px; border-top:1px solid #e2e8f0; display:grid; gap:12px; background:var(--bg);}
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    input, button {
      padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff;
    }
    input{min-width: 160px;}
    button { background:var(--c1); color:#fff; border:none; cursor:pointer; font-weight:600; }
    button:disabled{opacity:.6; cursor:progress}
    .badge { padding:4px 10px; border-radius:999px; background:#eef; font-size:12px; color:#334155; }
    .card { padding:14px; border:1px solid #e2e8f0; border-radius:14px; background:var(--card); box-shadow:0 1px 2px rgba(2,6,23,.04);}
    .muted { color:var(--muted) }
    .loading { cursor: progress; opacity: .85 }
    .error { color:var(--err) }
    .ok { color:var(--ok) }
    .pill {
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      font-weight:700; letter-spacing:.2px;
    }
    .pill.green{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0 }
    .pill.yellow{ background:#fffbeb; color:#92400e; border:1px solid #fde68a }
    .pill.red{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca }
    .legend{font-size:12px;color:#334155}
  </style>
</head>
<body>
<header>
  <strong style="font-size:18px;color:var(--c2)">AmazonSafe ‚Äì Mapa</strong>
  <span class="badge">API: amazonsafe-api.onrender.com</span>
  <div class="row" style="margin-left:auto">
    <input id="cidade" placeholder="Cidade (ex: Bel√©m-PA)" />
    <input id="lat" type="number" step="0.0001" placeholder="Lat" style="width:120px" />
    <input id="lon" type="number" step="0.0001" placeholder="Lon" style="width:120px" />
    <button id="btnGo" title="Geocodifica + An√°lise + Focos">Buscar & Analisar</button>
  </div>
</header>

<div id="map"></div>

<section class="panel">
  <div class="row">
    <div class="card" style="flex:1">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <strong>√öltimos alertas</strong>
        <span class="legend">‚Ä¢ c√≠rculo menor = foco fraco ‚Ä¢ maior = foco forte</span>
      </div>
      <pre id="alertasBox" style="white-space:pre-wrap; font-size:12px; margin:8px 0 0"></pre>
    </div>
    <div class="card" style="flex:1">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <strong>Resultado da an√°lise</strong>
        <span id="nivelPill" class="pill green" style="display:none">‚Äî</span>
      </div>
      <div id="metaBox" class="muted" style="font-size:12px;margin-top:6px"></div>
      <pre id="resumoBox" style="white-space:pre-wrap; font-size:12px; margin:10px 0 0"></pre>
    </div>
  </div>
</section>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script>
  const API = "https://amazonsafe-api.onrender.com";

  const map = L.map('map').setView([-3.1, -60.0], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let focosLayer = L.layerGroup().addTo(map);

  const elCidade = document.querySelector('#cidade');
  const elLat = document.querySelector('#lat');
  const elLon = document.querySelector('#lon');
  const btnGo = document.querySelector('#btnGo');
  const resumoBox = document.querySelector('#resumoBox');
  const alertasBox = document.querySelector('#alertasBox');
  const metaBox = document.querySelector('#metaBox');
  const nivelPill = document.querySelector('#nivelPill');

  function setLoading(on) {
    [btnGo].forEach(b => b.disabled = on);
    document.body.classList.toggle('loading', on);
  }

  function pill(level){
    const lv = (level||'').toLowerCase();
    nivelPill.style.display = 'inline-flex';
    nivelPill.className = 'pill ' + (lv.startsWith('ver') ? 'green' : lv.startsWith('ama') ? 'yellow' : lv.startsWith('verme') ? 'red' : 'green');
    const emoji = lv.startsWith('ver') ? 'üü¢' : lv.startsWith('ama') ? 'üü°' : lv.startsWith('verme') ? 'üî¥' : '‚ö™';
    nivelPill.textContent = `${emoji} ${level?.toUpperCase?.() || 'N/A'}`;
  }

  async function fetchJson(url, opts) {
    const r = await fetch(url, opts);
    if (!r.ok) {
      const text = await r.text().catch(() => '');
      throw new Error(`HTTP ${r.status} ${r.statusText} ‚Äì ${text?.slice(0,200)}`);
    }
    return r.json();
  }

  function getParamsFromUI() {
    const cidade = elCidade.value.trim();
    const lat = parseFloat(elLat.value);
    const lon = parseFloat(elLon.value);
    if (cidade) return { cidade };
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
      throw new Error("Informe a cidade **ou** latitude/longitude v√°lidos.");
    }
    return { lat, lon };
  }

  function extractCoords(resp, fallback){
    // tenta pegar do padr√£o que voc√™ j√° usa no backend (/api/alertas_update)
    if (resp?.params?.lat && resp?.params?.lon) return { lat: resp.params.lat, lon: resp.params.lon };
    if (resp?.lat && resp?.lon) return { lat: resp.lat, lon: resp.lon };
    if (resp?.resolve?.lat && resp?.resolve?.lon) return { lat: resp.resolve.lat, lon: resp.resolve.lon };
    return fallback;
  }

  // Plota focos do INPE
  async function carregarFocos(params) {
    focosLayer.clearLayers();
    const qs = new URLSearchParams({ scope: "diario", region: "Brasil", limit: 300, ...params }).toString();
    const data = await fetchJson(`${API}/api/inpe/focos?${qs}`);
    const focos = (data.features && data.features.focos) || [];

    focos.forEach(f => {
      const m = L.circleMarker([f.latitude, f.longitude], {
        radius: Math.max(3, Math.min(12, (f.frp || 1) / 8)),
        color: '#ef4444', weight: 1, fillOpacity: 0.65
      }).bindPopup(`
        <div><strong>${f.municipio || ''} - ${f.uf || ''}</strong></div>
        <div>Sat√©lite: ${f.satelite || '-'}</div>
        <div>FRP: ${f.frp ?? '-'}</div>
        <div>Bioma: ${f.bioma || '-'}</div>
      `);
      m.addTo(focosLayer);
    });

    if (focos.length) {
      const bounds = L.latLngBounds(focos.map(f => [f.latitude, f.longitude]));
      map.fitBounds(bounds.pad(0.2));
    }
    return { count: focos.length, params };
  }

  // Fluxo √∫nico: geocodifica + roda an√°lise + plota focos
  async function executar() {
    setLoading(true);
    resumoBox.className = '';
    metaBox.textContent = '';
    try {
      const uiParams = getParamsFromUI();

      // 1) roda a an√°lise (usa sua pr√≥pria geocodifica√ß√£o do backend)
      resumoBox.textContent = "Processando an√°lise...";
      const data = await fetchJson(`${API}/api/alertas_update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ...uiParams,
          scope: "diario",
          region: "Brasil",
          raio_km: 150,
          air_radius_m: 10000,
          weather_provider: "open-meteo"
        })
      });

      // badge de n√≠vel
      pill(data?.score?.level || 'n/a');

      // meta: cidade resolvida / timestamp
      const resolved = data?.params?.resolve?.display_name || data?.params?.cidade || elCidade.value.trim();
      const when = data?.score?.alert_obs?.meta?.observed_at || data?.observed_at || '';
      metaBox.innerHTML = `Local: <strong>${resolved || '‚Äî'}</strong> ‚Ä¢ √öltima observa√ß√£o: <strong>${when || '‚Äî'}</strong>`;

      // 2) pega coords retornadas pela API (ou usa UI) e plota focos
      const coords = extractCoords(data, uiParams);
      const res = await carregarFocos(coords);

      resumoBox.className = 'ok';
      resumoBox.textContent =
        `Focos plotados: ${res.count}\nFonte: INPE (CSV)\nParams: ${JSON.stringify(coords)}`;

      // 3) atualiza ‚Äú√öltimos alertas‚Äù
      await carregarUltimosAlertas();
    } catch (err) {
      resumoBox.className = 'error';
      resumoBox.textContent = `Erro: ${err.message}`;
      console.error(err);
    } finally {
      setLoading(false);
    }
  }

  async function carregarUltimosAlertas() {
    try {
      alertasBox.textContent = "Carregando √∫ltimos alertas...";
      const data = await fetchJson(`${API}/api/alertas?limit=5`);
      alertasBox.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      alertasBox.textContent = `Erro ao carregar alertas: ${err.message}`;
    }
  }

  btnGo.addEventListener('click', executar);
  // Enter no campo cidade dispara a busca
  elCidade.addEventListener('keydown', (e)=>{ if(e.key==='Enter') executar(); });

  // Inicial
  carregarUltimosAlertas();
</script>
</body>
</html>
