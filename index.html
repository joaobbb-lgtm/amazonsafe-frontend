<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>AmazonSafe ‚Äì Mapa e Alertas</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#16a34a',
            amberish: '#f59e0b',
            slateish: '#0f172a',
          }
        }
      }
    }
  </script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

  <style>
    #map { height: 64vh; min-height: 380px; }
    .pill { @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- HEADER -->
  <header class="sticky top-0 z-20 bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4 flex-wrap">
      <div class="flex items-center gap-3 min-w-[280px]">
        <!-- logo (troque por assets/logo.png se quiser) -->
        <div class="h-10 w-10 rounded-full bg-emerald-100 flex items-center justify-center text-2xl">üåø</div>
        <div>
          <div class="text-xl font-extrabold">
            Amazon<span class="text-emerald-600">Safe</span>
          </div>
          <div class="text-sm text-gray-500 -mt-0.5">Monitoramento Ambiental Inteligente</div>
        </div>

        <span class="ml-2 text-xs bg-indigo-50 text-indigo-700 px-2.5 py-1 rounded-full">
          API: amazonsafe-api.onrender.com
        </span>
      </div>

      <div class="ml-auto flex gap-2 flex-wrap">
        <input id="cidade" placeholder="Cidade (ex: Bel√©m, PA)" class="p-2 border border-gray-300 rounded-lg min-w-[210px] text-gray-800" />
        <input id="lat" type="number" step="0.0001" placeholder="Lat" class="p-2 border border-gray-300 rounded-lg w-28 text-gray-800" />
        <input id="lon" type="number" step="0.0001" placeholder="Lon" class="p-2 border border-gray-300 rounded-lg w-28 text-gray-800" />
        <button id="btnGo" class="p-2 px-4 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-lg transition duration-150 disabled:opacity-60 disabled:cursor-not-allowed">
          Buscar & Analisar
        </button>
      </div>
    </div>
  </header>

  <!-- KPIs -->
  <main class="max-w-7xl mx-auto px-3 lg:px-4">
    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mt-4">
      <!-- √Ågua -->
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
        <div class="border-b-4 border-emerald-500 rounded-t-xl"></div>
        <div class="p-4">
          <p class="text-xs uppercase text-gray-500 font-semibold">√Ågua (chuva/cheia)</p>
          <p id="aguaTitulo" class="text-3xl font-bold text-emerald-800 mt-1">‚Äî</p>
          <p id="aguaInfo" class="text-sm text-gray-600 mt-1">‚Äî</p>
          <span id="aguaBadge" class="pill bg-emerald-100 text-emerald-700 mt-2">‚Äî</span>
        </div>
      </div>

      <!-- Ar -->
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
        <div class="border-b-4 border-sky-500 rounded-t-xl"></div>
        <div class="p-4">
          <p class="text-xs uppercase text-gray-500 font-semibold">Qualidade do Ar</p>
          <p id="arTitulo" class="text-3xl font-bold text-sky-800 mt-1">‚Äî</p>
          <p id="arInfo" class="text-sm text-gray-600 mt-1">‚Äî</p>
          <span id="arBadge" class="pill bg-sky-100 text-sky-700 mt-2">‚Äî</span>
        </div>
      </div>

      <!-- Desmatamento (proxy) -->
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
        <div class="border-b-4 border-emerald-700 rounded-t-xl"></div>
        <div class="p-4">
          <p class="text-xs uppercase text-gray-500 font-semibold">Desmatamento (proxy)</p>
          <p id="desmTitulo" class="text-3xl font-bold text-emerald-900 mt-1">‚Äî</p>
          <p id="desmInfo" class="text-sm text-gray-600 mt-1">‚Äî</p>
          <span id="desmBadge" class="pill bg-emerald-100 text-emerald-700 mt-2">‚Äî</span>
        </div>
      </div>

      <!-- Focos -->
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
        <div class="border-b-4 border-red-600 rounded-t-xl"></div>
        <div class="p-4">
          <p class="text-xs uppercase text-gray-500 font-semibold">Focos de Inc√™ndio</p>
          <p id="focosTitulo" class="text-3xl font-bold text-red-700 mt-1">‚Äî</p>
          <p id="focosInfo" class="text-sm text-gray-600 mt-1">‚Äî</p>
          <span id="focosBadge" class="pill bg-red-100 text-red-700 mt-2">‚Äî</span>
        </div>
      </div>
    </section>

    <!-- MAPA + LADO DIREITO -->
    <section class="grid lg:grid-cols-3 gap-4 mt-4">
      <div class="lg:col-span-2 bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div id="map"></div>
      </div>

      <aside class="flex flex-col gap-4">
        <!-- Hist√≥rico de risco (gr√°fico simples) -->
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
          <h3 class="font-semibold text-emerald-800 mb-2">Hist√≥rico de Risco</h3>
          <div class="h-40">
            <canvas id="riscoHistorico"></canvas>
          </div>
        </div>

        <!-- Resultado da an√°lise -->
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
          <div class="flex items-center gap-3 flex-wrap">
            <strong class="text-lg font-semibold text-emerald-800">Resultado da an√°lise</strong>
            <span id="nivelPill" class="pill bg-gray-100 text-gray-700">‚Äî</span>
          </div>
          <div id="metaBox" class="text-gray-500 text-xs mt-2">
            Local: <strong>‚Äî</strong> ‚Ä¢ √öltima observa√ß√£o: <strong>‚Äî</strong>
          </div>

          <div class="grid grid-cols-2 gap-2 mt-3">
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
              <b class="block text-xs text-gray-600 mb-1">Score (0‚Äì1)</b>
              <div id="scoreVal" class="text-xl font-mono text-emerald-800">‚Äî</div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
              <b class="block text-xs text-gray-600 mb-1">Thresholds</b>
              <div id="thresholds" class="text-xs font-mono text-gray-600">
                verde &lt; 0.33 ‚Ä¢ amarelo 0.33‚Äì0.66 ‚Ä¢ vermelho ‚â• 0.66
              </div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
              <b class="block text-xs text-gray-600 mb-1">Severity</b>
              <div id="sevVal" class="text-base font-mono text-gray-800">‚Äî</div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
              <b class="block text-xs text-gray-600 mb-1">Duration</b>
              <div id="durVal" class="text-base font-mono text-gray-800">‚Äî</div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
              <b class="block text-xs text-gray-600 mb-1">Frequency</b>
              <div id="freqVal" class="text-base font-mono text-gray-800">‚Äî</div>
            </div>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
              <b class="block text-xs text-gray-600 mb-1">Impact</b>
              <div id="impVal" class="text-base font-mono text-gray-800">‚Äî</div>
            </div>
          </div>

          <pre id="resumoBox" class="whitespace-pre-wrap text-sm mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-700"></pre>
        </div>

        <!-- √öltimos alertas -->
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
          <div class="flex justify-between items-center gap-2">
            <strong class="text-lg font-semibold text-emerald-800">√öltimos alertas</strong>
            <span class="text-xs text-gray-500">‚Ä¢ c√≠rculo menor = foco fraco</span>
          </div>
          <pre id="alertasBox" class="whitespace-pre-wrap text-xs mt-3 bg-gray-50 border border-gray-200 rounded-lg p-2"></pre>
        </div>
      </aside>
    </section>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ====== CONFIG ===========================================================
    const API = "https://amazonsafe-api.onrender.com";

    // ====== DOM ==============================================================
    const elCidade = document.querySelector('#cidade');
    const elLat    = document.querySelector('#lat');
    const elLon    = document.querySelector('#lon');
    const btnGo    = document.querySelector('#btnGo');

    // KPIs
    const aguaTitulo = document.querySelector('#aguaTitulo');
    const aguaInfo   = document.querySelector('#aguaInfo');
    const aguaBadge  = document.querySelector('#aguaBadge');

    const arTitulo = document.querySelector('#arTitulo');
    const arInfo   = document.querySelector('#arInfo');
    const arBadge  = document.querySelector('#arBadge');

    const desmTitulo = document.querySelector('#desmTitulo');
    const desmInfo   = document.querySelector('#desmInfo');
    const desmBadge  = document.querySelector('#desmBadge');

    const focosTitulo = document.querySelector('#focosTitulo');
    const focosInfo   = document.querySelector('#focosInfo');
    const focosBadge  = document.querySelector('#focosBadge');

    // Resultado
    const nivelPill = document.querySelector('#nivelPill');
    const metaBox   = document.querySelector('#metaBox');
    const scoreVal  = document.querySelector('#scoreVal');
    const sevVal    = document.querySelector('#sevVal');
    const durVal    = document.querySelector('#durVal');
    const freqVal   = document.querySelector('#freqVal');
    const impVal    = document.querySelector('#impVal');
    const resumoBox = document.querySelector('#resumoBox');

    const alertasBox = document.querySelector('#alertasBox');

    // ====== MAPA =============================================================
    const map = L.map('map').setView([-3.1, -60.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    let focosLayer = L.layerGroup().addTo(map);

    // ====== GR√ÅFICO ==========================================================
    const riscoCtx = document.getElementById('riscoHistorico').getContext('2d');
    const riscoChart = new Chart(riscoCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{ label: 'Score', data: [], borderColor: 'rgb(16, 185, 129)', tension: 0.3, pointRadius: 4 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { min: 0, max: 1 } },
        plugins: { legend: { display: false } }
      }
    });

    // ====== HELPERS (robustos) ==============================================
    const get = (obj, path, def = undefined) => {
      try { return path.split('.').reduce((o,k)=> (o && k in o) ? o[k] : undefined, obj) ?? def; }
      catch { return def; }
    };
    const num = (v, def=null) => {
      const n = (typeof v === 'string' && v.trim() === '') ? NaN : Number(v);
      return Number.isFinite(n) ? n : def;
    };
    const clamp01 = (x) => Math.max(0, Math.min(1, x));

    // chuva 24h e √≠ndice de cheia vindos do backend novo (score.breakdown)
    function getPrecipMM(resp) {
      const fromBreak = num(get(resp, 'score.breakdown.precip_24h_mm'), null);
      if (fromBreak !== null) return fromBreak;

      // compat com modelo antigo (open-meteo)
      const pm = num(get(resp, 'weather.features.precipitation'), null)
              ?? num(get(resp, 'weather.current.precipitation'), null);
      return pm;
    }
    function getRainIndex(resp) {
      const idx = num(get(resp, 'score.breakdown.precip_index'), null);
      if (idx !== null) return clamp01(idx);
      // fallback: se n√£o tiver √≠ndice, calcula algo simples a partir da chuva
      const mm = getPrecipMM(resp);
      if (!Number.isFinite(mm)) return null;
      const low  = Math.min(1, mm / 10);   // 10mm+ = 1
      const high = Math.min(1, Math.max(0, (mm - 70) / 50)); // 70‚Üí120mm mapeia 0‚Üí1
      return clamp01(Math.max(low, high));
    }
    function rainLevel(rainIdx) {
      if (!Number.isFinite(rainIdx)) return ['Sem dados', 'bg-gray-100 text-gray-700', '‚Äî'];
      if (rainIdx < 0.33) return ['Baixo', 'bg-emerald-100 text-emerald-700', 'OK'];
      if (rainIdx < 0.66) return ['Moderado', 'bg-amber-100 text-amber-800', 'Aten√ß√£o'];
      return ['Alto', 'bg-red-100 text-red-700', 'Risco de cheia'];
    }

    function setPill(el, text, classes) {
      el.textContent = text;
      el.className = `pill ${classes}`;
    }
    function setNivelPill(level) {
      const lv = (level || '').toLowerCase();
      let c = 'pill ';
      let t = '‚Äî';
      if (lv.startsWith('verme')) { c += 'bg-red-100 text-red-700'; t = 'üî¥ VERMELHO'; }
      else if (lv.startsWith('ama')) { c += 'bg-amber-100 text-amber-800'; t = 'üü° AMARELO'; }
      else if (lv.startsWith('ver')) { c += 'bg-emerald-100 text-emerald-700'; t = 'üü¢ VERDE'; }
      else { c += 'bg-gray-100 text-gray-700'; }
      nivelPill.className = c; nivelPill.textContent = t;
    }

    // ====== FETCH WRAPPER ====================================================
    async function fetchJson(url, opts) {
      const r = await fetch(url, opts);
      if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
      return r.json();
    }

    // ====== CARREGAR FOCOS E DEFINIR KPI PROXY DESMATAMENTO =================
    async function carregarFocos(params) {
      focosLayer.clearLayers();
      const qs = new URLSearchParams({ scope: "diario", region: "Brasil", limit: 300, ...params }).toString();
      const data = await fetchJson(`${API}/api/inpe/focos?${qs}`);
      const focos = (data.features && data.features.focos) || [];

      const frps = [];
      focos.forEach(f => {
        if (Number.isFinite(+f.frp)) frps.push(+f.frp);
        const m = L.circleMarker([f.latitude, f.longitude], {
          radius: Math.max(3, Math.min(12, (f.frp || 1) / 8)),
          color: '#b91c1c', weight: 1, fillOpacity: 0.75
        }).bindPopup(`
          <div><strong>${f.municipio || ''} - ${f.uf || ''}</strong></div>
          <div>Sat√©lite: ${f.satelite || '-'}</div>
          <div>FRP: ${f.frp ?? '-'}</div>
          <div>Bioma: ${f.bioma || '-'}</div>
        `);
        m.addTo(focosLayer);
      });

      if (focos.length) {
        const bounds = L.latLngBounds(focos.map(f => [f.latitude, f.longitude]));
        map.fitBounds(bounds.pad(0.2));
      }

      // KPI Focos
      focosTitulo.textContent = focos.length ? (focos.length >= 150 ? 'Cr√≠tico' : focos.length >= 50 ? 'Alerta' : 'Baixo') : 'Baixo';
      focosInfo.textContent   = `Focos: ${focos.length}`;
      const focosClass = (focos.length >= 150) ? 'bg-red-100 text-red-700' : (focos.length >= 50) ? 'bg-amber-100 text-amber-800' : 'bg-emerald-100 text-emerald-700';
      setPill(focosBadge, focosTitulo.textContent, focosClass);

      // KPI Desmatamento (proxy por FRP m√©dio)
      const avgFRP = frps.length ? (frps.reduce((a,b)=>a+b,0)/frps.length) : 0;
      let desmLevel = 'Baixo', desmClass = 'bg-emerald-100 text-emerald-700';
      if (avgFRP >= 7) { desmLevel = 'Alto'; desmClass = 'bg-red-100 text-red-700'; }
      else if (avgFRP >= 3) { desmLevel = 'Moderado'; desmClass = 'bg-amber-100 text-amber-800'; }
      desmTitulo.textContent = desmLevel;
      desmInfo.textContent   = `FRP m√©dio: ${avgFRP ? avgFRP.toFixed(1) : '‚Äî'}`;
      setPill(desmBadge, desmLevel, desmClass);

      return { count: focos.length, avgFRP };
    }

    // ====== √öLTIMOS ALERTAS ==================================================
    async function carregarUltimosAlertas() {
      try {
        const data = await fetchJson(`${API}/api/alertas?limit=5`);
        alertasBox.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        alertasBox.textContent = `Erro ao carregar alertas: ${e.message}`;
      }
    }

    // ====== EXECU√á√ÉO PRINCIPAL ==============================================
    function getParamsFromUI() {
      const cidade = elCidade.value.trim();
      const lat = num(elLat.value, null);
      const lon = num(elLon.value, null);
      if (cidade) return { cidade };
      if (lat === null || lon === null) throw new Error("Informe a cidade **ou** latitude/longitude v√°lidos.");
      return { lat, lon };
    }
    function extractCoords(resp, fallback) {
      if (get(resp, 'params.lat') && get(resp, 'params.lon')) return { lat: resp.params.lat, lon: resp.params.lon };
      if (get(resp, 'lat') && get(resp, 'lon')) return { lat: resp.lat, lon: resp.lon };
      if (get(resp, 'params.resolve.lat') && get(resp, 'params.resolve.lon')) return { lat: resp.params.resolve.lat, lon: resp.params.resolve.lon };
      return fallback;
    }

    function setLoading(on) { btnGo.disabled = on; }

    async function executar() {
      setLoading(true);
      resumoBox.className = 'whitespace-pre-wrap text-sm mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-700';
      try {
        const uiParams = getParamsFromUI();
        resumoBox.textContent = "Processando an√°lise...";

        // 1) Chama pipeline (faz geocode, coleta, calcula score + rainfall index)
        const data = await fetchJson(`${API}/api/alertas_update`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ...uiParams,
            scope: "diario",
            region: "Brasil",
            raio_km: 150,
            air_radius_m: 10000,
            weather_provider: "open-meteo"
          })
        });

        // 2) KPI √ÅGUA (novo: usa breakdown.precip_24h_mm e precip_index)
        const mm  = getPrecipMM(data);
        const rix = getRainIndex(data);
        const [lvlTxt, lvlClass, badgeTxt] = rainLevel(rix);
        aguaTitulo.textContent = lvlTxt;
        aguaInfo.textContent   = Number.isFinite(mm) ? `Chuva 24h: ${mm.toFixed(1)} mm` : 'Sem dados';
        setPill(aguaBadge, badgeTxt, lvlClass);

        // 3) KPI AR (PM2.5 se dispon√≠vel)
        const pm25 = num(get(data, 'air.features.pm25'), null)
                  ?? num(get(data, 'air.pm25'), null);
        if (Number.isFinite(pm25)) {
          arTitulo.textContent = (pm25 < 12) ? 'Bom' : (pm25 < 35) ? 'Moderado' : 'Ruim';
          arInfo.textContent   = `PM2.5: ${pm25.toFixed(1)} ¬µg/m¬≥`;
          const c = (pm25 < 12) ? 'bg-emerald-100 text-emerald-700' : (pm25 < 35) ? 'bg-amber-100 text-amber-800' : 'bg-red-100 text-red-700';
          setPill(arBadge, arTitulo.textContent, c);
        } else {
          arTitulo.textContent = '‚Äî';
          arInfo.textContent   = 'Sem dados';
          setPill(arBadge, '‚Äî', 'bg-gray-100 text-gray-700');
        }

        // 4) Resultado da an√°lise
        setNivelPill(get(data, 'score.level', 'N/A'));
        const resolved = get(data, 'params.resolve.display_name') || get(data, 'params.cidade') || elCidade.value.trim() || '‚Äî';
        const when = get(data, 'score.alert_obs.meta.observed_at') || get(data, 'observed_at') || '‚Äî';
        metaBox.innerHTML = `Local: <strong>${resolved}</strong> ‚Ä¢ √öltima observa√ß√£o: <strong>${when}</strong>`;

        const s  = num(get(data, 'score.score'), null);
        const br = get(data, 'score.breakdown', {});
        scoreVal.textContent = (s !== null) ? s.toFixed(2) : '‚Äî';
        sevVal.textContent   = Number.isFinite(+br.severity)  ? (+br.severity).toFixed(2)  : '‚Äî';
        durVal.textContent   = Number.isFinite(+br.duration)  ? (+br.duration).toFixed(2)  : '‚Äî';
        freqVal.textContent  = Number.isFinite(+br.frequency) ? (+br.frequency).toFixed(2) : '‚Äî';
        impVal.textContent   = Number.isFinite(+br.impact)    ? (+br.impact).toFixed(2)    : '‚Äî';

        // 5) Focos + Desmatamento proxy
        const coords = extractCoords(data, uiParams);
        const resFocos = await carregarFocos(coords);

        resumoBox.classList.add('text-emerald-700', 'font-semibold');
        resumoBox.textContent =
          `Focos plotados: ${resFocos.count}\nFonte: INPE (CSV)\nParams: ${JSON.stringify(coords, null, 2)}`;

        // 6) Hist√≥rico (anexa ponto)
        const ts = new Date().toLocaleDateString('pt-BR', { month:'2-digit', day:'2-digit' });
        if (s !== null) {
          riscoChart.data.labels.push(ts);
          riscoChart.data.datasets[0].data.push(s);
          if (riscoChart.data.labels.length > 20) {
            riscoChart.data.labels.shift();
            riscoChart.data.datasets[0].data.shift();
          }
          riscoChart.update();
        }

        // 7) √öltimos alertas
        await carregarUltimosAlertas();

      } catch (err) {
        resumoBox.classList.add('text-red-700', 'font-semibold');
        resumoBox.textContent = `Erro: ${err.message}`;
        console.error(err);
      } finally {
        setLoading(false);
      }
    }

    // ====== EVENTS / INIT ====================================================
    btnGo.addEventListener('click', executar);
    elCidade.addEventListener('keydown', (e) => { if (e.key === 'Enter') executar(); });
    carregarUltimosAlertas();
  </script>
</body>
</html>
